generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  MINER_USER
  TRADER_USER
  REFINER_USER
  ADMIN_USER
}

enum CounterpartyType {
  INDIVIDUAL_ASM
  COOPERATIVE
  SMALL_SCALE_OPERATOR
  TRADER_AGGREGATOR
}

enum GoldType {
  RAW_GOLD
  BAR
  LOT
}

// ─── Core models ────────────────────────────────────────

model User {
  id            String   @id @default(uuid()) @db.Uuid
  role          Role
  username      String   @unique @db.VarChar(50)
  phone_e164    String   @unique @db.VarChar(20)
  password_hash String?  @db.Text
  is_disabled   Boolean  @default(false)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  sessions            Session[]
  miner_profile       MinerProfile?
  passkey_credentials PasskeyCredential[]
  documents           Document[]
  records             Record[]
  purchases           Purchase[]
  audit_logs          AuditLog[]
  compliance_reviews  ComplianceReview[] @relation("ComplianceReviewer")
  sales_partners_as_miner   SalesPartner[] @relation("MinerPartners")
  sales_partners_as_partner SalesPartner[] @relation("PartnerMiners")
  mine_sites          MineSite[]
  record_receipts     RecordReceipt[]
  intended_records    Record[] @relation("IntendedBuyer")

  @@map("users")
}

model Session {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String   @db.Uuid
  expires_at DateTime
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([expires_at])
  @@map("sessions")
}

model MinerProfile {
  user_id               String           @id @db.Uuid
  counterparty_type     CounterpartyType
  full_name             String           @db.VarChar(200)
  home_language         String           @default("en") @db.VarChar(10)

  // Phase 2: onboarding fields
  nrc_number            String?          @db.VarChar(30)
  date_of_birth         DateTime?        @db.Date
  gender                String?          @db.VarChar(20)
  mine_site_name        String?          @db.VarChar(200)
  mine_site_location    String?          @db.VarChar(500)
  mining_license_number String?          @db.VarChar(100)
  profile_completed_at  DateTime?

  consent_version       String?          @db.VarChar(20)
  consented_at          DateTime?
  created_at            DateTime         @default(now())
  updated_at            DateTime         @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("miner_profiles")
}

// Sales partner relationships (miner → trader/refiner)
model SalesPartner {
  id         String   @id @default(uuid()) @db.Uuid
  miner_id   String   @db.Uuid
  partner_id String   @db.Uuid
  created_at DateTime @default(now())

  miner   User @relation("MinerPartners", fields: [miner_id], references: [id], onDelete: Cascade)
  partner User @relation("PartnerMiners", fields: [partner_id], references: [id], onDelete: Cascade)

  @@unique([miner_id, partner_id])
  @@index([partner_id])
  @@map("sales_partners")
}

// Phase 2: consent text storage
model ConsentVersion {
  version      String   @id @db.VarChar(20)
  published_at DateTime @default(now())
  text_en      String   @db.Text
  text_bem     String   @db.Text

  @@map("consent_versions")
}

// ─── Placeholder models (expanded in later phases) ──────

// Expanded in Phase 7
model PasskeyCredential {
  id            String   @id @default(uuid()) @db.Uuid
  user_id       String   @db.Uuid
  credential_id Bytes
  public_key    Bytes
  counter       Int      @default(0)
  created_at    DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("passkey_credentials")
}

// Expanded in Phase 3
model Document {
  id          String   @id @default(uuid()) @db.Uuid
  user_id     String   @db.Uuid
  doc_type    String   @db.VarChar(50)
  file_path   String   @db.Text
  uploaded_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("documents")
}

// Phase 3: gold record with structured fields
model Record {
  id               String    @id @default(uuid()) @db.Uuid
  record_number    String?   @unique @db.VarChar(20)
  created_by       String    @db.Uuid
  status           String    @default("DRAFT") @db.VarChar(30)

  weight_grams     Decimal?  @db.Decimal(10, 3)
  estimated_purity Decimal?  @db.Decimal(5, 2)
  origin_mine_site String?   @db.VarChar(500)
  extraction_date  DateTime? @db.Date
  gold_type        GoldType?
  notes            String?   @db.Text

  // Phase 6: vision capture fields
  scale_photo_data String?   @db.Text
  scale_photo_mime String?   @db.VarChar(50)
  xrf_photo_data   String?   @db.Text
  xrf_photo_mime   String?   @db.VarChar(50)
  gps_latitude     Decimal?  @db.Decimal(10, 7)
  gps_longitude    Decimal?  @db.Decimal(10, 7)
  country          String?   @db.VarChar(100)
  locality         String?   @db.VarChar(500)
  mine_site_id     String?   @db.Uuid
  buyer_id         String?   @db.Uuid

  // Phase 4: purchase tracking
  purchased_by     String?   @db.Uuid
  purchased_at     DateTime?

  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  creator            User              @relation(fields: [created_by], references: [id])
  mine_site          MineSite?         @relation(fields: [mine_site_id], references: [id])
  intended_buyer     User?             @relation("IntendedBuyer", fields: [buyer_id], references: [id])
  photos             RecordPhoto[]
  purchase_items     PurchaseItem[]
  source_entries     RecordSourceEntry[]
  compliance_reviews ComplianceReview[]
  metal_purities     MetalPurity[]
  receipts           RecordReceipt[]

  @@index([created_by])
  @@index([status])
  @@index([mine_site_id])
  @@map("records")
}

// Phase 3: photo evidence stored as base64
model RecordPhoto {
  id         String   @id @default(uuid()) @db.Uuid
  record_id  String   @db.Uuid
  photo_data String   @db.Text
  mime_type  String   @default("image/jpeg") @db.VarChar(50)
  taken_at   DateTime @default(now())

  record Record @relation(fields: [record_id], references: [id], onDelete: Cascade)

  @@index([record_id])
  @@map("record_photos")
}

// Phase 4: trader purchases (chain of custody)
model Purchase {
  id             String   @id @default(uuid()) @db.Uuid
  trader_id      String   @db.Uuid
  total_weight   Decimal  @db.Decimal(10, 3)
  total_items    Int
  notes          String?  @db.Text
  purchased_at   DateTime @default(now())
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  // Phase 6: Yellow Card payment fields (nullable — no impact on existing data)
  price_per_gram  Decimal? @db.Decimal(10, 2)
  total_price     Decimal? @db.Decimal(15, 2)
  currency        String?  @default("ZMW") @db.VarChar(3)
  payment_status  String?  @default("NONE") @db.VarChar(30)

  trader   User           @relation(fields: [trader_id], references: [id])
  items    PurchaseItem[]
  payments Payment[]

  @@index([trader_id])
  @@map("purchases")
}

model PurchaseItem {
  id             String   @id @default(uuid()) @db.Uuid
  purchase_id    String   @db.Uuid
  record_id      String   @db.Uuid

  // Phase 6: per-item pricing (nullable)
  price_per_gram Decimal? @db.Decimal(10, 2)
  line_total     Decimal? @db.Decimal(15, 2)

  purchase Purchase @relation(fields: [purchase_id], references: [id], onDelete: Cascade)
  record   Record   @relation(fields: [record_id], references: [id])

  @@unique([purchase_id, record_id])
  @@index([record_id])
  @@map("purchase_items")
}

// Phase 6: Yellow Card payment tracking
model Payment {
  id                  String    @id @default(uuid()) @db.Uuid
  purchase_id         String    @db.Uuid
  yellowcard_txn_id   String?   @db.VarChar(200)
  type                String    @db.VarChar(30)  // COLLECTION or DISBURSEMENT
  amount              Decimal   @db.Decimal(15, 2)
  currency            String    @default("ZMW") @db.VarChar(3)
  status              String    @default("CREATED") @db.VarChar(30)
  payment_method      String?   @db.VarChar(50)  // BANK_TRANSFER, MOBILE_MONEY
  fee_amount          Decimal?  @db.Decimal(10, 2)
  fee_currency        String?   @db.VarChar(3)
  recipient_id        String?   @db.Uuid  // for disbursements to miners
  yellowcard_meta     Json?
  webhook_received_at DateTime?
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  purchase Purchase @relation(fields: [purchase_id], references: [id], onDelete: Cascade)

  @@index([purchase_id])
  @@index([yellowcard_txn_id])
  @@index([status])
  @@map("payments")
}

// Expanded in Phase 4
model RecordSourceEntry {
  id        String @id @default(uuid()) @db.Uuid
  record_id String @db.Uuid
  label     String @db.VarChar(100)
  value     String @db.Text

  record Record @relation(fields: [record_id], references: [id], onDelete: Cascade)

  @@map("record_source_entries")
}

// Phase 5: compliance review of gold records
model ComplianceReview {
  id          String   @id @default(uuid()) @db.Uuid
  record_id   String   @db.Uuid
  reviewer_id String   @db.Uuid
  status      String   @db.VarChar(30)
  notes       String?  @db.Text
  reviewed_at DateTime @default(now())

  record   Record @relation(fields: [record_id], references: [id], onDelete: Cascade)
  reviewer User   @relation("ComplianceReviewer", fields: [reviewer_id], references: [id])

  @@index([record_id])
  @@index([reviewer_id])
  @@map("compliance_reviews")
}

// Expanded in Phase 8
model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String?  @db.Uuid
  action     String   @db.VarChar(100)
  entity     String   @db.VarChar(100)
  entity_id  String?  @db.Uuid
  meta       Json?
  created_at DateTime @default(now())

  user User? @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([entity, entity_id])
  @@map("audit_logs")
}

// ─── Phase 6: Mine Sites, Metal Purities, Receipts ──────

model MineSite {
  id                    String   @id @default(uuid()) @db.Uuid
  miner_id              String   @db.Uuid
  name                  String   @db.VarChar(500)
  gps_latitude          Decimal? @db.Decimal(10, 7)
  gps_longitude         Decimal? @db.Decimal(10, 7)
  mining_license_number String?  @db.VarChar(200)
  is_default            Boolean  @default(false)
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  miner   User     @relation(fields: [miner_id], references: [id])
  records Record[]

  @@index([miner_id])
  @@map("mine_sites")
}

model MetalPurity {
  id         String   @id @default(uuid()) @db.Uuid
  record_id  String   @db.Uuid
  receipt_id String?  @db.Uuid
  element    String   @db.VarChar(5)
  purity     Decimal  @db.Decimal(7, 4)
  sort_order Int      @default(0)

  record  Record         @relation(fields: [record_id], references: [id], onDelete: Cascade)
  receipt RecordReceipt? @relation(fields: [receipt_id], references: [id], onDelete: Cascade)

  @@index([record_id])
  @@index([receipt_id])
  @@map("metal_purities")
}

model RecordReceipt {
  id               String   @id @default(uuid()) @db.Uuid
  record_id        String   @db.Uuid
  received_by      String   @db.Uuid
  receipt_weight   Decimal? @db.Decimal(10, 3)
  scale_photo_data String?  @db.Text
  scale_photo_mime String?  @db.VarChar(50)
  xrf_photo_data   String?  @db.Text
  xrf_photo_mime   String?  @db.VarChar(50)
  gps_latitude     Decimal? @db.Decimal(10, 7)
  gps_longitude    Decimal? @db.Decimal(10, 7)
  country          String?  @db.VarChar(100)
  locality         String?  @db.VarChar(500)
  received_at      DateTime @default(now())
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  record   Record        @relation(fields: [record_id], references: [id], onDelete: Cascade)
  receiver User          @relation(fields: [received_by], references: [id])
  purities MetalPurity[]

  @@index([record_id])
  @@index([received_by])
  @@map("record_receipts")
}

// Phase 6: record number sequence counter
model RecordCounter {
  id    String @id @default("singleton") @db.VarChar(20)
  value Int    @default(0)

  @@map("record_counters")
}
